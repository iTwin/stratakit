name: PR

on:
  pull_request:
    types: [opened, synchronize]
  push:
    branches:
      - dependabot/**

jobs:
  assign-author:
    name: Assign PR author
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'opened'

    steps:
      - name: Auto-assign author using github-script
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = context.payload.pull_request.number;
            const prAuthor = context.actor;

            try {
              const permissionInfo = await github.rest.repos.getCollaboratorPermissionLevel({
                owner: owner,
                repo: repo,
                username: prAuthor,
              });

              if (permissionInfo.data.permission === "admin" || permissionInfo.data.permission === "write") {
                github.rest.issues.addAssignees({
                  owner: owner,
                  repo: repo,
                  issue_number: prNumber,
                  assignees: [prAuthor]
                });
              } else {
                console.log("Author does not have write access to the repository.");
              }
            } catch (error) {
              console.log("Failed checking permissions or assigning author");
              console.error(error);
            }

  assign-milestones:
    name: Assign PR milestones
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && (github.event.action == 'opened' || github.event.action == 'synchronize')

    steps:
      - name: Auto-assign milestones using github-script
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pr = context.payload.pull_request;

            const prNumber = pr.number;
            const prAuthor = context.actor;

            try {

              // hard code default milestone
              let targetMilestone = "2025 Q2";

              // look at files changed
              const files = await github.paginate(
                github.rest.pulls.listFiles,
                {
                  owner: owner,
                  repo: repo,
                  pull_number: prNumber
                }
              );

              for (const file of files) {
                const fileName = file.filename;
                console.log('current file', fileName);

                if (fileName.startsWith('packages/compat') || fileName.startsWith('apps/test-app/app/compat')) {
                  console.log('part of compat, add API bridge');
                  targetMilestone = 'API bridge';
                  break;
                }
              }

              // if synchronizing, update milestone appropriately (only if new milestone is different)
              const oldMilestone = pr.milestone ? pr.milestone.title : null;
              console.log('old milestone', oldMilestone);

              if (oldMilestone !== targetMilestone) {
                console.log('changing because new milestone is different');
                // find milestone to apply
                const milestones = await github.rest.issues.listMilestones({
                  owner: owner,
                  repo: repo,
                  state: 'open'
                });
                console.log('existing milestones', milestones);
                const milestone = milestones.data.find(m => m.title === targetMilestone);
                console.log('found target milestone', milestone);

                // apply milestone to the PR
                await github.rest.issues.update({
                  owner: owner,
                  repo: repo,
                  issue_number: prNumber,
                  milestone: milestone ? milestone.number : null
                });
              }
            } catch (error) {
              console.log("Failed assigning milestones");
              console.error(error);
            }

  assign-labels:
    name: Assign PR labels
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && (github.event.action == 'opened' || github.event.action == 'synchronize')

    steps:
      - name: Auto-assign labels using github-script
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pr = context.payload.pull_request;

            const prNumber = pr.number;
            const prAuthor = context.actor;
            const headBranch = pr.head.ref;

            const labelsToAdd = new Set();

            // helper function to add label
            function addLabel(label, labelNames) {

              // get component label
              const componentLabel = `component: ${label}`;
              if (labelNames.has(componentLabel)) {
                labelsToAdd.add(componentLabel);
              }
            }

            try {
              // add labels based on paths of files changed

              // get existing labels
              const labels = await github.paginate(
                github.rest.issues.listLabelsForRepo,
                {
                  owner: owner,
                  repo: repo,
                  per_page: 100
                }
              );
              const labelNames = new Set(labels.map(label => label.name));
              console.log('labelNames',labelNames);

              // get files changed
              const files = await github.paginate(
                github.rest.pulls.listFiles,
                {
                  owner: owner,
                  repo: repo,
                  pull_number: prNumber
                }
              );

              // determine labels based on files changed
              for (const file of files) {
                const fileName = file.filename;
                console.log('current file', fileName);

                if (fileName.startsWith('packages/')) {
                  console.log('part of packages');

                  const relativePath = fileName.slice('packages/'.length);
                  console.log('relative path', relativePath);

                  if (relativePath.startsWith('bricks/src') || relativePath.startsWith('compat/') || relativePath.startsWith('structures/src')) {

                    // add API bridge label if under compat
                    if (relativePath.startsWith('compat/')) {
                      console.log('part of compat, add API bridge');
                      labelsToAdd.add('API bridge');
                    }

                    // isolate name of file changed
                    const changedFile = relativePath.split('/').pop().split('.')[0];
                    console.log('isolated component name', changedFile);
                    addLabel(changedFile, labelNames);
                  }
                } else if (fileName.startsWith('apps/test-app/app/')) {
                  console.log('part of test app');

                  const relativePath = fileName.slice('apps/test-app/app/'.length);
                  console.log('relative path', relativePath);

                  if (relativePath.startsWith('tests/') || relativePath.startsWith('compat/')) {

                    // add API bridge label if under compat
                    if (relativePath.startsWith('compat/')) {
                      console.log('part of compat, add API bridge');
                      labelsToAdd.add('API bridge');
                    }

                    // isolate component changed
                    const componentChanged = relativePath.startsWith('tests/') ? relativePath.split('/')[1] : relativePath.split('/').pop().split('.')[0];
                    console.log('isolated component name', componentChanged);

                    // convert to camel case
                    const componentName = componentChanged
                      .split('-')
                      .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                      .join('');
                    console.log('converted to camel case', componentName);

                    addLabel(componentName, labelNames);
                  }
                } else if (fileName.startsWith('.github')) {
                  console.log('part of github');
                  labelsToAdd.add('github_actions');
                }
              }

              // if synchronizing, remove any outdated labels
              const currentLabels = await github.rest.issues.listLabelsOnIssue({
                owner: owner,
                repo: repo,
                issue_number: prNumber
              });
              const currentLabelNames = new Set(currentLabels.data.map(label => label.name));
              console.log('current labels', currentLabelNames);

              const finalLabelsAdd = [...labelsToAdd].filter(label => !currentLabelNames.has(label));
              const finalLabelsRemove = [...currentLabelNames].filter(label => !labelsToAdd.has(label));

              console.log('to remove', finalLabelsRemove);
              console.log('to add', finalLabelsAdd);

              // remove irrelevant labels from the PR
              for (const label of finalLabelsRemove) {
                await github.rest.issues.removeLabel({
                  owner: owner,
                  repo: repo,
                  issue_number: prNumber,
                  name: label
                });
              }

              // add relevant labels to the PR
              if (finalLabelsAdd.length > 0) {
                await github.rest.issues.addLabels({
                  owner: owner,
                  repo: repo,
                  issue_number: prNumber,
                  labels: finalLabelsAdd
                });
              }
            } catch (error) {
              console.log("Failed assigning labels");
              console.error(error);
            }

  fix-formatting:
    name: Fix formatting
    runs-on: ubuntu-latest
    if: contains(github.ref_name, 'dependabot/')

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref_name }}

      - uses: pnpm/action-setup@v4
        with:
          version: 9.15.4

      - name: Use Node 22.x
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: "pnpm"

      - run: pnpm install

      - name: Format code
        run: pnpm prettier --write && pnpm format --write

      - name: Commit changes
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git commit -am "format code" || echo "No changes to commit"
          git push
